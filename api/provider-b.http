### File variables
#@DATA-SERVICE-A-HOST = apollo-provider-a.127.0.0.1.nip.io:8080
@SCORPIO-A-HOST = scorpio-provider-a.127.0.0.1.nip.io:8080
@SCORPIO-B-HOST = scorpio-provider-b.127.0.0.1.nip.io:8080

@DATA-SERVICE-A-HOST = mp-data-service-a.127.0.0.1.nip.io:8080

@DATA-SERVICE-B-HOST = mp-data-service-B.127.0.0.1.nip.io:8080

mp-data-service-a.127.0.0.1.nip.io:8080
### Entity CRUD lifecycle

### -- 01. Create an entity on provider-b data service 
POST http://{{SCORPIO-B-HOST}}/ngsi-ld/v1/entities
Content-Type: application/ld+json

{
    "id": "urn:ngsi-ld:PhotovoltaicMeasurement:fms-1",
    "type": "PhotovoltaicMeasurement",
    "name": {
        "type": "Property",
        "value": "SmartPV Station 1"
    },
    "nominalPeakPowerGeneration": {
        "type": "Property",
        "value": "95"
    },
    "@context": ["https://raw.githubusercontent.com/smart-data-models/dataModel.GreenEnergy/master/context.jsonld"]
}


### -- 02. Get an entity on provider-b data service
@02_ENTITY-ID = urn:ngsi-ld:PhotovoltaicMeasurement:fms-1

GET http://{{SCORPIO-B-HOST}}/ngsi-ld/v1/entities/{{02_ENTITY-ID}}
Accept: application/json


### -- 03. Update an entity on provider-b data service
@03_ENTITY-ID = urn:ngsi-ld:PhotovoltaicMeasurement:fms-1
PUT http://{{SCORPIO-B-HOST}}/ngsi-ld/v1/entities/{{03_ENTITY-ID}}
Content-Type: application/ld+json

{
    "type": "PhotovoltaicMeasurement",
    "name": {
        "type": "Property",
        "value": "SmartPV Station 1"
    },
    "nominalPeakPowerGeneration": {
        "type": "Property",
        "value": "100"
    },
    "@context": ["https://raw.githubusercontent.com/smart-data-models/dataModel.GreenEnergy/master/context.jsonld"]
}


### -- 04. Delete an entity on provider-b data service
@04_ENTITY-ID = urn:ngsi-ld:PhotovoltaicMeasurement:fms-1

DELETE http://{{SCORPIO-A-HOST}}/ngsi-ld/v1/entities/{{04_ENTITY-ID}}



### Federation of brokers -- Direct access to the context brokers APIs

# ### -- 05. Register provider-b into the federator broker provider-a
# POST http://{{SCORPIO-A-HOST}}/ngsi-ld/v1/csourceRegistrations
# Content-Type: application/ld+json

# {
#     "id": "urn:ngsi-ld:ContextSourceRegistration:provider-b",
#     "type": "ContextSourceRegistration",
#     "information": [
#         {
#             "entities": [
#                 {
#                     "type": "PhotovoltaicMeasurement"
#                 }
#             ]
#         }
#     ],
#     "endpoint": "http://{{SCORPIO-B-HOST}}",
#     "@context": ["https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context-v1.7.jsonld"]
# }

### -- 05. Register provider-b into the federator broker provider-a
POST http://{{SCORPIO-A-HOST}}/ngsi-ld/v1/csourceRegistrations
Content-Type: application/ld+json

{
    "id": "urn:ngsi-ld:ContextSourceRegistration:provider-b",
    "type": "ContextSourceRegistration",
    "information": [
        {
            "entities": [
                {
                    "type": "PhotovoltaicMeasurement"
                }
            ]
        }
    ],
    "endpoint": "http://{{SCORPIO-B-HOST}}",
    "@context": ["https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context-v1.7.jsonld"]
}

### -- 06. Get the registered context sources on provider-a data service for a given entity type
@ENTITY-TYPE = PhotovoltaicMeasurement

GET http://{{SCORPIO-A-HOST}}/ngsi-ld/v1/csourceRegistrations/?type={{ENTITY-TYPE}}
Accept: application/ld+json


### -- 07. Delete a context source registration on provider-a data service
@07_CSOURCE-REGISTRATION-ID = urn:ngsi-ld:ContextSourceRegistration:provider-b

DELETE http://{{SCORPIO-A-HOST}}/ngsi-ld/v1/csourceRegistrations/{{07_CSOURCE-REGISTRATION-ID}}
Accept: application/json


### -- 08. Get an entity created on provider-b data service from provider-a data service
@02_ENTITY-ID = urn:ngsi-ld:PhotovoltaicMeasurement:fms-1

GET http://{{SCORPIO-A-HOST}}/ngsi-ld/v1/entities/{{02_ENTITY-ID}}
Accept: application/json



### Federation of brokers -- Access to the data services APIs through the auth layer
#$ export USER_CREDENTIAL=$(./get_credential_for_consumer.sh http://keycloak-provider-b.127.0.0.1.nip.io:8080 user-credential); echo ${USER_CREDENTIAL}
#$ ./get_access_token_oid4vp.sh http://mp-data-service-a.127.0.0.1.nip.io:8080 $USER_CREDENTIAL user ../wallet

@USER_ACCESS_TOKEN = eyJhbGciOiJSUzI1NiIsImtpZCI6InRVRmNHWlRSN29sMWxGdlpZUDFoOTVILXFlVzlITnNyS3RVUXRCMmpNLU0iLCJ0eXAiOiJKV1QifQ.eyJhdWQiOlsiZGF0YS1zZXJ2aWNlIl0sImNsaWVudF9pZCI6ImRpZDprZXk6ekRuYWVTeEt0c01GNHZ1d0RjVHpqbTJNeUNwUXZUOEhvRE05MzhkRkNkUGV4aHZwQyIsImV4cCI6MTc0MDc2Njg4NSwiaXNzIjoiZGlkOmtleTp6RG5hZVN4S3RzTUY0dnV3RGNUemptMk15Q3BRdlQ4SG9ETTkzOGRGQ2RQZXhodnBDIiwia2lkIjoidFVGY0daVFI3b2wxbEZ2WllQMWg5NUgtcWVXOUhOc3JLdFVRdEIyak0tTSIsInN1YiI6IiIsInZlcmlmaWFibGVDcmVkZW50aWFsIjp7IkBjb250ZXh0IjpbImh0dHBzOi8vd3d3LnczLm9yZy8yMDE4L2NyZWRlbnRpYWxzL3YxIiwiaHR0cHM6Ly93d3cudzMub3JnL25zL2NyZWRlbnRpYWxzL3YxIl0sImNyZWRlbnRpYWxTdWJqZWN0Ijp7ImVtYWlsIjoidGVzdEB1c2VyLm9yZyIsImZpcnN0TmFtZSI6IlRlc3QiLCJsYXN0TmFtZSI6IlJlYWRlciJ9LCJpZCI6InVybjp1dWlkOjdjNDY0ZmI4LTIzODItNGZjNy1hMjkzLTBlMmIwNWUwOWJiOCIsImlzc3VhbmNlRGF0ZSI6IjIwMjUtMDItMjhUMTc6NTA6MDFaIiwiaXNzdWVyIjoiZGlkOmtleTp6RG5hZW9MOUZxdVBSdnZkWFV0UUt2Q3lzUGdlSERHNDREdmtlV3VQY2czc3BaQ01RIiwidHlwZSI6WyJVc2VyQ3JlZGVudGlhbCJdfX0.1A0n1U2EgQ4jzJM862oqTUhpmYA3i1R-xaPKywt40IhFCCOhemPj-Vm7D0_x_3FP7laZSKkA-f664M0dTWOoOazKoVdM4u5BWu-tv_Ll_C7oaMx_TomnTEdOTRsM37rJMcbbyeyyirbR-QvgA1nw8SISpQPbAAfciLMmtJKLiadM2G5EOydll6BM7dV1jSVHScDEnwH6Wrk3phpzWKfctXF0ye4AbYftDWAMn-AyUXeGKMrPuYsIXhlmnkvqNu4P0hR66nddGKECl52CUoOIjG3DSgfJgZH3NzYGpNuNIojqpFtPRXPTlvouLq8DhAgruviPfPzrenyk5iV02UjaSQ


### -- 09. Register provider-b into the federator broker provider-an with auth for a given entity type
@09_ENTITY-TYPE = PhotovoltaicMeasurement

POST http://{{DATA-SERVICE-A-HOST}}/ngsi-ld/v1/csourceRegistrations
Content-Type: application/ld+json
Authorization: Bearer {{USER_ACCESS_TOKEN}}

{
    "id": "urn:ngsi-ld:ContextSourceRegistration:provider-b",
    "type": "ContextSourceRegistration",
    "information": [
        {
            "entities": [
                {
                    "type": "{{09_ENTITY-TYPE}}"
                }
            ]
        }
    ],
    "endpoint": "http://{{SCORPIO-B-HOST}}",
    "@context": ["https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context-v1.7.jsonld"]
}


### -- 10. Delete a context source registration on provider-a data service
@10_CSOURCE-REGISTRATION-ID = urn:ngsi-ld:ContextSourceRegistration:provider-b

DELETE http://{{DATA-SERVICE-A-HOST}}/ngsi-ld/v1/csourceRegistrations/{{07_CSOURCE-REGISTRATION-ID}}
Accept: application/json
Authorization: Bearer {{USER_ACCESS_TOKEN}}